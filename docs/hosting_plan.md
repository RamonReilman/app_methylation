# Hosting plan                                                                                                                                                                                                               
## Ramon Reilman                                                                                                                                                                                                             
                                                                                                                                                                                                                             
### Benodigdheden                                                                                                                                                                                                            
                                                                                                                                                                                                                             
* Apache                                                                                                                                                                                                                     
* Panel                                                                                                                                                                                                                      
* sudo rechten                                                                                                                                                                                                               
                                                                                                                                                                                                                             
## Stappen plan (Met rechten)                                                                                                                                                                                                
                                                                                                                                                                                                                             
### stap 1                                                                                                                                                                                                                   
Om apache te laten werken moeten er eerst een aantal dingen veranderd worden in de httpd-conf                                                                                                                                
De # voor de volgende regel moet weg worden gehaald.                                                                                                                                                                         
                                                                                                                                                                                                                             
```{shell}                                                                                                                                                                                                                   
Include /private/etc/apache2/extra/httpd-vhosts.conf                                                                                                                                                                         
                                                                                                                                                                                                                             
```                                                                                                                                                                                                                          
Hiermee wordt het gebruik van virtual host aangezet.                                                                                                                                                                         
Virtual hosts worden gebruikt om meerdere websites te runnen op 1 machine.                                                                                                                                                   
Ze werken 'ip-based', dit houd in dat elke website een andere IP adres heeft.                                                                                                                                                
Of 'name-based', hierbij heeft elke website een andere naam en gebruiken ze hetzelfde IP adres.                                                                                                                              
                                                                                                                                                                                                                             
Ook zijn een aantal afhankelijkheden nodig:                                                                                                                                                                                  
                                                                                                                                                                                                                             
```{shell}                                                                                                                                                                                                                   
LoadModule xml2enc_module libexec/apache2/mod_xml2enc.so                                                                                                                                                                     
LoadModule proxy_html_module libexec/apache2/mod_proxy_html.so                                                                                                                                                               
LoadModule proxy_module libexec/apache2/mod_proxy.so                                                                                                                                                                         
LoadModule proxy_http_module libexec/apache2/mod_proxy_http.so                                                                                                                                                               
LoadModule proxy_wstunnel_module libexec/apache2/mod_proxy_wstunnel.so                                                                                                                                                       
```                                                                                                                                                                                                                          
                                                                                                                                                                                                                             
Hierna kan een virtual host gemaakt worden in `httpd-vhosts.conf`                                                                                                                                                            
                                                                                                                                                                                                                             
```                                                                                                                                                                                                                          
<VirtualHost *:8080>                                                                                                                                                                                                         
    ServerName localhost                                                                                                                                                                                                     
                                                                                                                                                                                                                             
    ProxyPreserveHost On                                                                                                                                                                                                     
    ProxyPass /hostingdemo/ws ws://127.0.0.1:5100/hostingdemo/ws                                                                                                                                                             
    ProxyPassReverse /hostingdemo/ws ws://127.0.0.1:5100/hostingdemo/ws                                                                                                                                                      
                                                                                                                                                                                                                             
    ProxyPass /hostingdemo http://127.0.0.1:5100/hostingdemo                                                                                                                                                                 
    ProxyPassReverse /hostingdemo http://127.0.0.1:5100/hostingdemo                                                                                                                                                          
                                                                                                                                                                                                                             
    <Directory />                                                                                                                                                                                                            
        Require all granted                                                                                                                                                                                                  
        Options -Indexes                                                                                                                                                                                                     
    </Directory>                                                                                                                                                                                                             
                                                                                                                                                                                                                             
    Alias /static /home/redman/jaar2/kwartaal2/datadashboard/.venv/lib/python3.13/site-packages/bokeh/server/static                                                                                                          
    <Directory /home/redman/jaar2/kwartaal2/datadashboard/.venv/lib/python3.13/site-packages/bokeh/server/static>                                                                                                            
        Options +Indexes                                                                                                                                                                                                     
    </Directory>                                                                                                                                                                                                             
                                                                                                                                                                                                                             
</VirtualHost>                                                                                                                                                                                                               
```                                                                                                                                                                                                                          
                                                                                                                                                                                                                             
met `<VirtualHost>` wordt aangegeven dat dit 1 van de runnende websites gaat worden                                                                                                                                          
`ServerName` wordt gebruikt om de websites te scheiden op basisc van naam                                                                                                                                                    
Hier kan ook een domein `www.voorbeeld.nl` geplaatst worden.                                                                                                                                                                 
                                                                                                                                                                                                                             
`ProxyPreserveHost` zorgt ervoor dat de Host header van de client's request niet omgezet wordt naar het ip van de backend                                                                                                    
`ProxyPass` wordt gebruikt om request naar de apache server door te sturen naar de backend server                                                                                                                            
requests op servernaam/methylatie/ws worden doorgestuurd naar ws://127.0.0.1:5100/methylatie/ws                                                                                                                              
                                                                                                                                                                                                                             
`ProxyPassReverse` zorgt ervoor dat reacties van de backend worden gestuurd naar de juiste response header.                                                                                                                  
een reactie van backend http://127.0.0.1:5100/methylatie wordt naar servernaam/methylatie gestuurd                                                                                                                           
                                                                                                                                                                                                                             
Daarna worden de gebruikte folders gegeven aan de server, die heeft een static folder nodig.                                                                                                                                 
                                                                                                                                                                                                                             
## Stap 2                                                                                                                                                                                                                    
De static folder bestaat nu wel, maar bevat nog niet de bestanden die nodig zijn                                                                                                                                             
                                                                                                                                                                                                                             
```{shell}                                                                                                                                                                                                                   
mkdir -p /home/redman/jaar2/kwartaal2/datadashboard/.venv/lib/python3.13/site-packages/bokeh/server/static/extensions/panel                                                                                                  
cp /home/redman/jaar2/kwartaal2/datadashboard/.venv/lib/python3.13/site-packages/panel/dist/panel.min.js /home/redman/jaar2/kwartaal2/datadashboard/.venv/lib/python3.13/site-packages/bokeh/server/static/extensions/panel/ 
```                                                                                                                                                                                                                          
                                                                                                                                                                                                                             
Hetzelfd moet gedaan worden voor css, images en bundled                                                                                                                                                                      
                                                                                                                                                                                                                             
## Stap 3                                                                                                                                                                                                                    
Nu kunnen de 2 servers gestart worden                                                                                                                                                                                        
```{shell}                                                                                                                                                                                                                   
sudo apachectl restart                                                                                                                                                                                                       
panel serve path/to/code --port=5100 --allow-websocket-origin                                                                                                                                                                
```                                                                                                                                                                                                                          
                                                                                                                                                                                                                             
Deze methode werkt alleen als je rechten hebt op de server waar je dit wil hosten.                                                                                                                                           
Mijn data en website staan op de assemblix server, deze kan ik vrijwel onmogelijk op mijn laptop krijgen.                                                                                                                    
Toch vroeg ik me af of het mogelijk is om de website toch te hosten zonder sudo.                                                                                                                                             
                                                                                                                                                                                                                             
## Stappen plan (zonder rechten)                                                                                                                                                                                             
                                                                                                                                                                                                                             
### Problemen                                                                                                                                                                                                                
Er zijn 2 problemen waar je tegen aan kan lopen als je dit wil doen:                                                                                                                                                         
1. poorten, omdat de website alleen maar werkt zal je een ssh verbinding moeten openen met open poorten.                                                                                                                     
Dit is goed oplosbaar                                                                                                                                                                                                        
```{shell}                                                                                                                                                                                                                   
ssh -L 5100:localhost:5100 assemblix                                                                                                                                                                                         
```                                                                                                                                                                                                                          
Dit werkt alleen als een proxyjump staat in ~/.ssh/config                                                                                                                                                                    
Nu is er met deze ssh verbinding een tunnel gemaakt door deze 2 poorten                                                                                                                                                      
                                                                                                                                                                                                                             
2. Static folder                                                                                                                                                                                                             
Omdat het hosten met apache gebeurt op mijn lokale laptop kan deze niet zomaar bij de static folders die op assemblix staan.                                                                                                 
Hiervoor is een applicatie gemaakt gelukkig: `sshfs`                                                                                                                                                                         
                                                                                                                                                                                                                             
Hiermee kan je files van een remote server mounten op je eigen systeem.                                                                                                                                                      
                                                                                                                                                                                                                             
```{shell}                                                                                                                                                                                                                   
sudo sshfs -o allow_other,IdentityFile=/home/redman/.ssh/school_key,port=4235 rreilman@bioinf.nl:/homes/rreilman/ /mnt/school_home/                                                                                          
```                                                                                                                                                                                                                          
Deze hoort ook te werken met het config bestand, maar dit is mij niet gelukt.                                                                                                                                                
Op deze manier mount je je home folder van de remote in je /mnt folder en kan je hierbij met je apache server                                                                                                                
                                                                                                                                                                                                                             
## Hoe?                                                                                                                                                                                                                      
                                                                                                                                                                                                                             
```{shell}                                                                                                                                                                                                                   
<VirtualHost *:80>                                                                                                                                                                                                           
    ServerName localhost                                                                                                                                                                                                     
                                                                                                                                                                                                                             
    ProxyPreserveHost On                                                                                                                                                                                                     
    ProxyPass /methylatie/ws ws://127.0.0.1:5100/ui/ws                                                                                                                                                                       
    ProxyPassReverse /methylatie/ws ws://127.0.0.1:5100/ui/ws                                                                                                                                                                
                                                                                                                                                                                                                             
    ProxyPass /methylatie http://127.0.0.1:5100/ui                                                                                                                                                                           
    ProxyPassReverse /methylatie http://127.0.0.1:5100/ui                                                                                                                                                                    
                                                                                                                                                                                                                             
    <Directory />                                                                                                                                                                                                            
        Require all granted                                                                                                                                                                                                  
        Options -Indexes                                                                                                                                                                                                     
    </Directory>                                                                                                                                                                                                             
                                                                                                                                                                                                                             
                                                                                                                                                                                                                             
    Alias /static /mnt/school_home/jaar2/kwartaal2/dashboard/app_methylation/.venv/lib/python3.11/site-packages/bokeh/server/static                                                                                          
    <Directory /mnt/school_home/jaar2/kwartaal2/dashboard/app_methylation/.venv/lib/python3.11/site-packages/bokeh/server/static>                                                                                            
        Options +Indexes                                                                                                                                                                                                     
        Require all granted                                                                                                                                                                                                  
    </Directory>                                                                                                                                                                                                             
</VirtualHost>                                                                                                                                                                                                               
                                                                                                                                                                                                                             
```                                                                                                                                                                                                                          
Hier wordt nu de gemounte fs van de assemblix server gebruikt als static folder                                                                                                                                              
Nu kunnen deze bestanden wel gevonden worden!                                                                                                                                                                                
                                                                                                                                                                                                                             
Als je nu dus over die ssh verbinding de server aanzet:                                                                                                                                                                      
```{shell}                                                                                                                                                                                                                   
ssh -L 5100:localhost:5100 assemblix                                                                                                                                                                                         
panel serve pad/naar/code --port=5100 --allow-websocket-origin='*'                                                                                                                                                           
```                                                                                                                                                                                                                          
Kan de server dus gehost worden zonder rechten nodig te hebben op de remote server!                                                                                                                                          
                                                                                                                                                                                                                             
Als je geluk heb kan je naar de website toe! Het is nog maar de vraag of ik mijn laptop aan het staan.                                                                                                                       
Maar wees ook zeker welkom om te vragen of ik het even aan wil zetten!                                                                                                                                                       
                                                                                                                                                                                                                             
`theredmanplays.com/methylatie`                                                                                                                                                                                              
(De website duurt lang met laden, vanwege de grote dataset)                                                                                                                                                                  
### Bronnen                                                                                                                                                                                                                  
“Apache Virtual Host Documentation - Apache HTTP Server Version 2.4.” Accessed January 19, 2025. https://httpd.apache.org/docs/2.4/vhosts/index.html.                                                                        
“Libfuse/Sshfs.” C. 2015. Reprint, libfuse, January 19, 2025. https://github.com/libfuse/sshfs.                                                                                                                              
“Mod_proxy - Apache HTTP Server Version 2.4.” Accessed January 19, 2025. https://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypass.                                                                                     
“VirtualHost Examples - Apache HTTP Server Version 2.4.” Accessed January 19, 2025. https://httpd.apache.org/docs/2.4/vhosts/examples.html.                                                                                  
                                                                                                                                                                                                                             
## Panel server performance                                                                                                                                                                                                  
                                                                                                                                                                                                                             
                                                                                                                                                                                                                             
                                                                                                                                                                                                                             
## Panel productie/release cycle                                                                                                                                                                                             
### Enviroments                                            
* development/staging
    - In deze omgeving wordt de code gemaakt en getest.
    De staging omegving lijkt heel erg veel op productie, en zal gebruikt worden om het product te testen. Zo wordt het product klaar gemaakt voor prod

* production
    - Dit is het product, in mijn geval de website, waar de gebruikers bij kunnen. Deze omgeving staat los van delopment.

Het is handig om deze 2 omgevingen gescheiden te houden van elkaar. De beste manier om dit te doen is om ze op 2 verschillende servers te runnen. Als er iets fout gaat tijdens het ontwikkelen, zal prod hier geen last van hebben.

### Updates
Het updaten van de productie omgeving zal ervoor zorgen dat de website tijdelijk onbereikbaar is, of even niet werkt. Het is dus niet verstandig om elke dag veranderingen uit te voeren op productie.

Ik zou updates, mits relevant, om de 1-2 maand uitvoeren, zo worden de gebruikers niet vaak beïnvloed.

Dit kan natuurlijk veranderd worden aan de hand van hoe nodig de update is.





